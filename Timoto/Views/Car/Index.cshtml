
@model CarFilterVM



@{
    ViewData["Title"] = "Cars";
}


<form id="antiForgeryForm" style="display: none;">
    @Html.AntiForgeryToken()
</form>

<div class="no-bottom no-top zebra" id="content">
    <div id="top"></div>

    <section id="subheader" class="jarallax text-light">
        <img src="~/assets/images/background/2.jpg" class="jarallax-img" alt="">
        <div class="center-y relative text-center">
            <div class="container">
                <div class="row">
                    <div class="col-md-12 text-center">
                        <h1>Cars</h1>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="section-cars">
        <div class="container">
            <div class="row">
                <!-- FILTER SECTION -->
                <div class="col-lg-3">
                    <form method="get" asp-controller="Car" asp-action="Index">
                        <!-- VEHICLE TYPE -->
                        <div class="item_filter_group">
                            <h4>Vehicle Type</h4>
                            <div class="de_form">
                                @foreach (var vehicle in ViewBag.VehicleTypes as List<VehicleType>)
                                {
                                    <div class="de_checkbox">
                                        <input id="vehicle_type_@vehicle.Id" name="SelectedVehicleTypeIds" type="checkbox" value="@vehicle.Id" @(Model.SelectedVehicleTypeIds.Contains(vehicle.Id) ? "checked" : "") />
                                        <label for="vehicle_type_@vehicle.Id">@vehicle.Name</label>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- BODY TYPE -->
                        <div class="item_filter_group">
                            <h4>Car Body Type</h4>
                            <div class="de_form">
                                @foreach (var body in ViewBag.BodyTypes as List<BodyType>)
                                {
                                    <div class="de_checkbox">
                                        <input id="body_type_@body.Id" name="SelectedBodyTypeIds" type="checkbox" value="@body.Id" @(Model.SelectedBodyTypeIds.Contains(body.Id) ? "checked" : "") />
                                        <label for="body_type_@body.Id">@body.Name</label>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- SEAT COUNT -->
                        <div class="item_filter_group">
                            <h4>Car Seats</h4>
                            <div class="de_form">
                                @foreach (var seat in ViewBag.SeatOptions as List<int>)
                                {
                                    <div class="de_checkbox">
                                        <input id="seat_@seat" name="SelectedSeatCounts" type="checkbox" value="@seat" @(Model.SelectedSeatCounts.Contains(seat) ? "checked" : "") />
                                        <label for="seat_@seat">@seat seats</label>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- ENGINE CAPACITY -->
                        <div class="item_filter_group">
                            <h4>Car Engine Capacity (cc)</h4>
                            <div class="de_form">
                                @{
                                    var engineRanges = new List<(string Label, string Value)>
                                {
                                ("1000 - 2000", "1000-2000"),
                                ("2000 - 4000", "2000-4000"),
                                ("4000 - 6000", "4000-6000"),
                                ("6000+", "6000-max")
                                };
                                }
                                @foreach (var range in engineRanges)
                                {
                                    var isChecked = Model.SelectedEngineRanges != null && Model.SelectedEngineRanges.Contains(range.Value);

                                    <div class="de_checkbox">
                                        <input id="engine_@range.Value" name="SelectedEngineRanges" type="checkbox" value="@range.Value" @(isChecked ? "checked" : "") />
                                        <label for="engine_@range.Value">@range.Label</label>
                                    </div>
                                }
                            </div>
                        </div>

                        <!-- PRICE -->
                        <div class="item_filter_group">
                            <h4>Price ($)</h4>
                            <div class="price-input">
                                <div class="field">
                                    <span>Min</span>
                                    <input type="number" name="MinPrice" min="0" max="2000" class="input-min" value="@Model.MinPrice">
                                </div>
                                <div class="field">
                                    <span>Max</span>
                                    <input type="number" name="MaxPrice" min="0" max="2000" class="input-max" value="@Model.MaxPrice">
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary mt-3">Apply Filters</button>
                    </form>
                </div>

                <!-- CAR DISPLAY SECTION -->
                <div class="col-lg-9">
                    <div id="car-list" class="row">
                        @foreach (Car car in Model.Cars)
                        {
                            <div class="col-xl-4 col-lg-6">
                                <div class="de-item mb30">
                                    <div class="d-img">
                                        @{
                                            var now = DateTime.Now;
                                            var activeBooking = car.Bookings?.FirstOrDefault(b =>
                                            now >= b.StartDate && now <= b.EndDate && !b.IsDeleted);
                                        }

                                        @if (activeBooking != null)
                                        {
                                            <div class="badge bg-danger mt-2">
                                                Reserved until: @activeBooking.EndDate.ToString("dd MMM yyyy HH:mm")
                                            </div>
                                        }
                                        <img src="~/assets/images/cars/@car.CarImages.FirstOrDefault(x => x.IsMain)?.ImageUrl" class="img-fluid" alt="">
                                    </div>
                                    <div class="d-info">
                                        <div class="d-text">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <h4 class="mb-0">@car.Name</h4>
                                                <button type="button" class="like-btn" data-car-id="@car.Id"
                                                        style="background: none; border: none;">
                                                    <i style="margin-top:10px" class="fa fa-heart @(Model.FavoriteCarIds.Contains(car.Id) ? "text-danger" : "text-muted")"></i>
                                                    <span class="like-count ms-1">@car.LikeCount</span>
                                                </button>
                                            </div>

                                            <div class="d-atr-group mt-2">
                                                <span class="d-atr"><img src="~/assets/images/icons/1.svg" alt="">@car.Seats</span>
                                                <span class="d-atr"><img src="~/assets/images/icons/3.svg" alt="">@car.Doors</span>
                                                <span class="d-atr"><img src="~/assets/images/icons/2.svg" alt="">@car.LuggageVolume</span>
                                                <span class="d-atr"><img src="~/assets/images/icons/4.svg" alt="">@car.BodyType?.Name</span>
                                            </div>

                                            <div class="d-price mt-2">
                                                Daily rate from <span>$@car.DailyPrice</span>
                                                <a class="btn-main" asp-controller="Car" asp-action="Detail" asp-route-id="@car.Id">Rent Now</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>

                    <!-- Loading göstəricisi -->
                    <div id="loading" class="text-center mt-3" style="display: none;">
                        <p>Loading...</p>
                    </div>

                </div>
            </div>
        </div>
    </section>
</div>
<a href="#" id="back-to-top"></a>

@section Scripts {
    <script>
        let skip = 6;
        let loading = false;
        let allLoaded = false;

        window.addEventListener('scroll', async function () {
            if (loading || allLoaded) return;

            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
                loading = true;
                document.getElementById("loading").style.display = "block";

                const response = await fetch(`/Car/LoadMoreCars?skip=${skip}`);
                const cars = await response.json();

                if (cars.length === 0) {
                    allLoaded = true;
                    document.getElementById("loading").innerHTML = "<p>No more cars to load.</p>";
                    return;
                }

                const container = document.getElementById("car-list");
                cars.forEach(car => {
                    container.innerHTML += `
                    <div class="col-xl-4 col-lg-6">
                        <div class="de-item mb30">
                            <div class="d-img">
                                ${car.isReserved ? `<div class="badge bg-danger mt-2">Currently Reserved</div>` : ""}
                                <img src="/assets/images/cars/${car.imageUrl}" class="img-fluid" alt="${car.name}">
                            </div>
                            <div class="d-info">
                                <div class="d-text">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h4 class="mb-0">${car.name}</h4>
                                        <button type="button" class="like-btn" data-car-id="${car.id}"
                                                style="background: none; border: none;">
                                            <i style="margin-top:10px" class="fa fa-heart text-muted"></i>
                                            <span class="like-count ms-1">${car.likeCount}</span>
                                        </button>
                                    </div>

                                    <div class="d-atr-group mt-2">
                                        <span class="d-atr"><img src="/assets/images/icons/1.svg" alt="">${car.seats}</span>
                                        <span class="d-atr"><img src="/assets/images/icons/3.svg" alt="">${car.doors}</span>
                                        <span class="d-atr"><img src="/assets/images/icons/2.svg" alt="">${car.luggageVolume}</span>
                                        <span class="d-atr"><img src="/assets/images/icons/4.svg" alt="">${car.bodyTypeName ?? ""}</span>
                                    </div>

                                    <div class="d-price mt-2">
                                        Daily rate from <span>$${car.dailyPrice}</span>
                                        <a class="btn-main" href="/Car/Detail/${car.id}">Rent Now</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                });

                skip += cars.length;
                loading = false;
                document.getElementById("loading").style.display = "none";
            }
        });

   
        document.addEventListener('click', function (e) {
            if (e.target.closest('.like-btn')) {
                e.preventDefault();
                const btn = e.target.closest('.like-btn');
                const carId = btn.dataset.carId;

                fetch('/Car/ToggleFavoriteAjax', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    },
                    body: new URLSearchParams({ carId: carId })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.requiresLogin) {
                            window.location.href = '/Account/Login?returnUrl=' + encodeURIComponent(window.location.pathname);
                            return;
                        }
                        if (data.success) {
                            const icon = btn.querySelector('i');
                            icon.classList.toggle('text-danger', data.isFavorite);
                            icon.classList.toggle('text-muted', !data.isFavorite);
                            btn.querySelector('.like-count').innerText = data.likeCount;
                        }
                    });
            }
        });
    </script>
}
